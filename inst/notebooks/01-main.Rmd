---
title: "main"
output:
  html_document: default
  html_notebook: default
---

```{r setup, include=FALSE, error=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NA, error = TRUE)
```

## Questions

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?

## Synopsis


## Data Processing

```{r message = FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(rprojroot)
library(R.utils)

root <- rprojroot::is_rstudio_project
root_file <- root$make_fix_file()
# root$find_file("REAME.md")
root_file()
```
### Set up project folders with `rprojroot`
```{r results='hold'}
cat("Setting up the project folders:\n")
project.data <- root_file("data")
project.extdata <- root_file("inst/extdata")
project.R <- root_file("R")

project.data
project.extdata
project.R
```

```{r message=FALSE, warning=FALSE}
downloadZip <- function(fileUrl, outDir="./data", bzip2 = FALSE) {
  # function to download zipped file and unpack
  temp <- tempfile()
  download.file(fileUrl, temp, mode = "wb")
  if (bzip2 == FALSE) {
    unzip(temp, exdir = outDir)
  }
  else {

    destfile <- paste(outDir, "dataset.csv", sep = "/")
    bunzip2(temp, destname = destfile, overwrite = TRUE)
  }
}
```


```{r cache=TRUE}
fileUrl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
cat("Unpacking the raw data file:\n")

outDir <- project.extdata             # folder for raw data
downloadZip(fileUrl, outDir = outDir, bzip2 = TRUE)   # download and unpack zip file
```


```{r cache=TRUE}
# read the CSV file to memory
dataFile <- paste(project.extdata, "dataset.csv", sep = "/")
stormdata.raw <- read.csv(dataFile)
stormdata <- stormdata.raw
```


```{r results='hold'}
# properties of the dataset
dim(stormdata.raw)
names(stormdata.raw)
str(stormdata.raw)
summary(stormdata.raw)
head(stormdata.raw)
```

### Event Types `EVTYPE`

```{r}
head(unique(stormdata.raw$EVTYPE), 10)
```

There are `r length(unique(stormdata.raw$EVTYPE))` different type of events.

We want to find which type of events is more harmful to population health. We could group by EVTYPE and showing the variables FATALITIES and INJURIES.


```{r}
byEvent.0 <- stormdata %>%
  select(EVTYPE, FATALITIES, INJURIES) %>%
  group_by(EVTYPE) %>%
  summarize(fatal.sum = sum(FATALITIES), injur.sum = sum(INJURIES)) %>%
  arrange(desc(fatal.sum), desc(injur.sum))

byEvent.0
```

```{r}
byEvent.1 <- stormdata %>%
  select(EVTYPE, FATALITIES, INJURIES) %>%
  group_by(EVTYPE) %>%
  summarize(injur.sum = sum(INJURIES), fatal.sum = sum(FATALITIES)) %>%
  arrange(desc(injur.sum), desc(fatal.sum))

byEvent.1
```


```{r fig.asp=1}

byEvent.005 <- byEvent.0[1:5, ]

p1 <- ggplot(byEvent.005, aes(x = EVTYPE, y = fatal.sum)) +
  geom_bar(stat = "identity") +
  xlab("Event Type") + ylab("Fatalities") +
  geom_text(aes(label=fatal.sum, vjust = -0.25))

p2 <- ggplot(byEvent.005, aes(EVTYPE, injur.sum)) +
  geom_bar(stat = "identity") +
  xlab("Event Type") + ylab("Injuries") +
  geom_text(aes(label=injur.sum, vjust = -0.25))

gridExtra::grid.arrange(p1, p2)
```

Tornados, Excessive heat, flash floods, heat and lightning are the weather events most harmful to the population accross the United States.

## Economic Damage
The property and crop damage are not in a unique monetary units; they use thousands, millions and billions. They are specified in the variables `PROPDMGEXP` and `CROPDMGEXP`.

We will start by converting the monetary damages to a consistent units. We will choose thousands.

```{r}
byDamage <- stormdata %>%
  select(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP) %>%
  group_by(EVTYPE) %>%
  mutate(PROPDMGEXP = as.factor(toupper(PROPDMGEXP)), 
         CROPDMGEXP = as.factor(toupper(CROPDMGEXP))) %>%
  mutate(PROPDMG.thousands = ifelse(PROPDMGEXP == "K", PROPDMG * 1,
                                    ifelse(PROPDMGEXP == "M", PROPDMG * 1000,
                                           ifelse(PROPDMGEXP == "B", PROPDMG * 1E6, 0)))) %>%
  mutate(CROPDMG.thousands = ifelse(CROPDMGEXP == "K", CROPDMG * 1,
                                    ifelse(CROPDMGEXP == "M", CROPDMG * 1000,
                                           ifelse(CROPDMGEXP == "B", CROPDMG * 1E6, 0))))
byDamage
```

```{r}
unique(byDamage$PROPDMGEXP)
```

```{r}
unique(byDamage$CROPDMGEXP)
```

```{r}
summary(byDamage)
str(byDamage)
```

There are some unspecified units in `PROPDMGEXP` and `CROPDMGEXP`.
There is no a reasonable way to determine the units or damage value from the remarks. Sometimes is thousands or in 10K, or other. Besides the identifiers `B`, `M` and `K`, there are additional characters and numbers entered in this variable. Since there is no way to etermine the units for the property or crop damage we are not considering these amounts.



```{r}
unknown <- stormdata %>%
  select(STATE, COUNTY, EVTYPE, PROPDMG, PROPDMGEXP, REMARKS) %>%
  filter(PROPDMGEXP == "7")
```


```{r}
byDamage <- stormdata %>%
  select(EVTYPE, PROPDMG, CROPDMG) %>%
  group_by(EVTYPE) %>%
  summarize(property.total = sum(PROPDMG), crop.total = sum(CROPDMG)) %>%
  arrange(desc(property.total), desc(crop.total))

byDamage

```


## Results

## Figures
Maximum: 03. Can use panels.

## Code
